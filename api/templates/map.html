<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive World Map</title>
    <link rel="stylesheet" href="http://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
      body {
          margin: 0;
          padding: 0;
          background-color: #000;
      }
      #map {
          width: 100w;
          height: 100vh;
          border: 1px solid #000;
          box-sizing: border-box;
      }
    </style>
</head>
<body>

<div id="map"></div>

<script src="http://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  var map = L.map('map').setView([26, 10], 2); 

  L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
    maxZoom: 19,
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  var geoJsonData = {
    "type": "FeatureCollection",
    "features": [
      {
        "type": "Feature",
        "properties": {
          "name": "France",
          "iso2": "FR",
        },
        "geometry": {
          "type": "Polygon",
          "coordinates": [[[2.4609375, 46.07323062540835], [2.4609375, 48.922499263758255], [5.80078125, 48.922499263758255], [5.80078125, 46.07323062540835], [2.4609375, 46.07323062540835]]]
        }
      },
      {
        "type": "Feature",
        "properties": {
          "name": "Germany",
          "iso2": "DE", 
        },
        "geometry": {
          "type": "Polygon",
          "coordinates": [[[10.01953125, 48.922499263758255], [10.01953125, 51.6180165487737], [14.4140625, 51.6180165487737], [14.4140625, 48.922499263758255], [10.01953125, 48.922499263758255]]]
        }
      },
      {
        "type": "Feature",
        "properties": {
            "name": "Australia",
            "iso2": "AU",
        },
        "geometry": {
            "type": "Polygon",
            "coordinates": [[[113.203125, -39.90973623453719], [153.28125, -39.90973623453719], [153.28125, -12.039320557540572], [113.203125, -12.039320557540572], [113.203125, -39.90973623453719]]]
        }
    },
    {
        "type": "Feature",
        "properties": {
            "name": "Brazil",
            "iso2": "BR",
        },
        "geometry": {
            "type": "Polygon",
            "coordinates": [[[-73.125, -7.710991655433217], [-34.8046875, -7.710991655433217], [-34.8046875, -33.137551192346145], [-73.125, -33.137551192346145], [-73.125, -7.710991655433217]]]
        }
    },
    {
        "type": "Feature",
        "properties": {
            "name": "Canada",
            "iso2": "CA",
        },
        "geometry": {
            "type": "Polygon",
            "coordinates": [[[-140.9765625, 41.80407814427234], [-52.3828125, 41.80407814427234], [-52.3828125, 70.37785394109224], [-140.9765625, 70.37785394109224], [-140.9765625, 41.80407814427234]]]
        }
    },
    {
        "type": "Feature",
        "properties": {
            "name": "China",
            "iso2": "CN",
        },
        "geometry": {
            "type": "Polygon",
            "coordinates": [[[73.4765625, 18.312810846425442], [134.6484375, 18.312810846425442], [134.6484375, 53.330872983017066], [73.4765625, 53.330872983017066], [73.4765625, 18.312810846425442]]]
        }
    },
    {
        "type": "Feature",
        "properties": {
            "name": "Egypt",
            "iso2": "EG",
        },
        "geometry": {
            "type": "Polygon",
            "coordinates": [[[25.13671875, 22.268764039073968], [36.2109375, 22.268764039073968], [36.2109375, 31.952162238024975], [25.13671875, 31.952162238024975], [25.13671875, 22.268764039073968]]]
        }
    },
    {
        "type": "Feature",
        "properties": {
            "name": "India",
            "iso2": "IN",
        },
        "geometry": {
            "type": "Polygon",
            "coordinates": [[[68.203125, 6.664607562172573], [97.3828125, 6.664607562172573], [97.3828125, 35.460669951495305], [68.203125, 35.460669951495305], [68.203125, 6.664607562172573]]]
        }
    },
    {
        "type": "Feature",
        "properties": {
            "name": "Kenya",
            "iso2": "KE",
        },
        "geometry": {
            "type": "Polygon",
            "coordinates": [[[33.75, -4.740675384778361], [41.8359375, -4.740675384778361], [41.8359375, 4.214943141390639], [33.75, 4.214943141390639], [33.75, -4.740675384778361]]]
        }
    },
    {
        "type": "Feature",
        "properties": {
            "name": "Russia",
            "iso2": "RU",
        },
        "geometry": {
            "type": "Polygon",
            "coordinates": [[[30.234375, 41.902277040963696], [180, 41.902277040963696], [180, 81.92318632602183], [30.234375, 81.92318632602183], [30.234375, 41.902277040963696]]]
        }
    },
    {
        "type": "Feature",
        "properties": {
            "name": "South Africa",
            "iso2": "ZA",
        },
        "geometry": {
            "type": "Polygon",
            "coordinates": [[[16.171875, -34.88593094075317], [32.34375, -34.88593094075317], [32.34375, -22.268764039073968], [16.171875, -22.268764039073968], [16.171875, -34.88593094075317]]]
        }
    },
    {
        "type": "Feature",
        "properties": {
            "name": "United States",
            "iso2": "US",
        },
        "geometry": {
            "type": "Polygon",
            "coordinates": [[[-125.5078125, 24.84656534821976], [-66.796875, 24.84656534821976], [-66.796875, 49.38237278700955], [-125.5078125, 49.38237278700955], [-125.5078125, 24.84656534821976]]]
        }
    },
    {
        "type": "Feature",
        "properties": {
            "name": "Italy",
            "iso2": "IT",
        },
        "geometry": {
            "type": "Polygon",
            "coordinates": [[
        [6.6279296875, 36.59788913307022], 
        [18.45703125, 36.59788913307022], 
        [18.45703125, 47.517200697839414], 
        [6.6279296875, 47.517200697839414], 
        [6.6279296875, 36.59788913307022]
        ]]
        }
    },
    {
        "type": "Feature",
        "properties": {
            "name": "Japan",
            "iso2": "JP",
        },
        "geometry": {
            "type": "Polygon",
            "coordinates": [[
        [122.34375, 24.206889622398023], 
        [153.984375, 24.206889622398023], 
        [153.984375, 45.89000815866184], 
        [122.34375, 45.89000815866184], 
        [122.34375, 24.206889622398023]
        ]]
    }
    },
    {
        "type": "Feature",
        "properties": {
            "name": "Mexico",
            "iso2": "MX",
        },
        "geometry": {
            "type": "Polygon",
            "coordinates": [[
        [-118.125, 14.434680215297268], 
        [-86.484375, 14.434680215297268], 
        [-86.484375, 32.54681317351514], 
        [-118.125, 32.54681317351514], 
        [-118.125, 14.434680215297268]
        ]]
        }
    },
    {
        "type": "Feature",
        "properties": {
            "name": "United Kingdom",
            "iso2": "GB",
        },
        "geometry": {
            "type": "Polygon",
            "coordinates": [[
        [-10.8544921875, 49.83798245308484], 
        [1.93359375, 49.83798245308484], 
        [1.93359375, 60.930432202923335], 
        [-10.8544921875, 60.930432202923335], 
        [-10.8544921875, 49.83798245308484]
        ]]
        }
    }
    ]
  };

  let cachedData = JSON.parse(localStorage.getItem('cachedData')) || {};

  function onEachFeature(feature, layer) {
    if (feature.properties && feature.properties.iso2) {
        layer.on('click', function() {
            const apiUrl = `http://sse-project-2.azure-api.net/shows?country=${feature.properties.iso2}`;
            if (cachedData[feature.properties.iso2]) {
                // Use cached data
                console.log("using cached data:", cachedData[feature.properties.iso2])
                // Prepare the data to include both shows and country name
                const countryData = {
                    country: feature.properties.name, // Dynamically get the country name from the feature properties
                    shows: cachedData[feature.properties.iso2] // The fetched shows data
                };

                localStorage.setItem('country', feature.properties.name);
                localStorage.setItem('countryShows', JSON.stringify(cachedData[feature.properties.iso2]));
                window.location.href = '/country';
            } else {
                console.log("Fetching data from:", apiUrl)
                fetch(apiUrl)
                    .then(response => response.json())
                    .then(data => {
                    console.log("Data received:", data)
                    // cache data
                    cachedData[feature.properties.iso2] = data;
                    localStorage.setItem('cachedData', JSON.stringify(cachedData));
                    console.log("caching data:", cachedData[feature.properties.iso2])

                    // Prepare the data to include both shows and country name
                    const countryData = {
                        country: feature.properties.name, // Dynamically get the country name from the feature properties
                        shows: data // The fetched shows data
                    };
                    localStorage.setItem('countryShows', JSON.stringify(data));
                    window.location.href = '/country';
                    })
                    .catch(error => console.error('Error:', error));
            }

        });
    }
  }
  L.geoJSON(geoJsonData, {
    onEachFeature: onEachFeature,
    style: function(feature) {
        return {
            color: '#333333',
            fillColor: 'red',
            weight: 2,
            opacity: 1, 
            fillOpacity: 0.45 
        };
    }
}).addTo(map);
</script>

</body>
</html>
